<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QIIAHSD_SEGUNDA_FONTE</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}
  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}

  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .choices{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:10px}
  @media (max-width:820px){ .choices{grid-template-columns:1fr} }
  .opt{
    display:flex;align-items:center;gap:10px; padding:10px 12px;
    border:1px solid var(--line); border-radius:12px; background:var(--chip);
    cursor:pointer; transition:background .15s ease, border-color .15s ease, transform .05s ease;
  }
  .opt:hover{background:var(--chipHover); border-color:#4f70ff; transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none; width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel); border-color:#6d28d9; box-shadow:0 0 0 1px #6d28d9 inset}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);
    border-radius:999px;background:var(--chip);cursor:pointer}
  .chip input{transform:scale(1.15)}
  .chip:hover{background:var(--chipHover);border-color:#4f70ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row input[type="text"]{flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #6d28d9, #10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>QIIAHSD_SEGUNDA_FONTE</h1>
    

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/—</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_QIIAHSD_SEGUNDA_FONTE" };
const CODE = "QIIAHSD_SEGUNDA_FONTE";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["QIIAHSD_SEGUNDA_FONTE"]; // ajuste se usar outro nome de liberação

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent = text; el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display = "block"; }
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d = onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d] = String(iso).split("-"); if(!y||!m||!d) return iso; return `${d}/${m}/${y}`; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp = new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:[row] }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const TOKEN = qs("token");
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ESCALAS ===== */
const LIKERT = [
  {v:0,l:'Nunca'}, {v:1,l:'Raramente'}, {v:2,l:'Às vezes'},
  {v:3,l:'Frequentemente'}, {v:4,l:'Sempre'}
];
const TRI = [
  {v:0,l:'Não'}, {v:2,l:'Em parte/depende'}, {v:4,l:'Sim'}
];
const HOURS = [
  {v:0,l:'0–1 h/sem'}, {v:1,l:'2–4 h/sem'}, {v:2,l:'5–9 h/sem'},
  {v:3,l:'10–20 h/sem'}, {v:4,l:'>20 h/sem'}
];

/* ===== ITENS (schema) =====
   id: string (ex.: "6A", "14")
   type: 'likert' | 'tri' | 'hours' | 'single' | 'checkbox' | 'text' | 'section'
   invert: true (apenas likert)
   required: false (para não obrigatórios)
   score: false (não entra no score/MAX)
*/
const AREAS_TAGS = [
  "Linguagem","Matemática","Ciências","Tecnologia","Artes visuais","Música",
  "Esportes","História","Filosofia","Programação","Xadrez/Estratégia","Escrita/Criação","Liderança/Projetos","Outros"
];
const MELHORES_TAGS = [
  "Língua Portuguesa","Matemática","Ciências/Engenharia","Tecnologia/Computação","Artes","Música","Esporte","Liderança/Projetos","Comunicação","Outros"
];

const ITEMS = [
  {id:"hdr0", type:"section", text:"Impressões gerais"},
  {id:"1", type:"tri", text:"Tem habilidade(s) especial(is) / se destaca?"},
  {id:"2", type:"tri", text:"Demonstra ser diferente das demais pessoas?"},
  {id:"3", type:"tri", text:"Apresenta atitudes diferentes das demais pessoas?"},
  {id:"4", type:"likert", text:"É tímido(a)? (descritor, não pontua)", required:false, score:false},
  {id:"5", type:"likert", text:"É extrovertido(a)? (descritor, não pontua)", required:false, score:false},

  {id:"hdr1", type:"section", text:"Leitura e interesses"},
  {id:"6A", type:"likert", text:"Lê por interesse próprio?"},
  {id:"6B", type:"hours", text:"Horas/semana de leitura por interesse."},
  {id:"7", type:"checkbox", text:"Assuntos/atividades preferidos (marque ≥3 se possível).", checkboxes:AREAS_TAGS},
  {id:"8", type:"single", text:"Idade dos 4 melhores amigos (predominante).", options:[
    {label:"Maioria da mesma idade", value:1},
    {label:"Mistura (alguns ±2 anos)", value:2},
    {label:"Maioria +3 a +6 anos (mais velhos)", value:3},
    {label:"Maioria >6 anos mais velhos", value:4},
    {label:"Maioria mais novos", value:2}
  ]},
  {id:"9", type:"checkbox", text:"Áreas em que é/era um dos melhores (até 4).", checkboxes:MELHORES_TAGS},

  {id:"hdr2", type:"section", text:"Traços socioemocionais e hábitos"},
  {id:"10", type:"likert", text:"Sente-se deslocado/diferente no pensar/sentir/agir?"},
  {id:"11", type:"likert", text:"Prefere trabalhar/estudar/treinar sozinho(a)?"},
  {id:"12", type:"likert", text:"Na infância, preferia livros difíceis/enciclopédias/atlas?"},
  {id:"13", type:"likert", text:"Independente para pensar e agir?"},
  {id:"14", type:"likert", text:"Senso de humor “diferente”?"},
  {id:"15", type:"likert", text:"Preocupação ética/moral/social/ambiental?"},
  {id:"16", type:"likert", text:"Perfeccionista?"},
  {id:"17", type:"likert", text:"Mais observador(a) que os demais?"},
  {id:"18", type:"likert", text:"Gosta de xadrez/estratégia?"},
  {id:"19", type:"likert", text:"Princípios éticos/morais próprios aplicados sempre?"},
  {id:"20", type:"likert", text:"Conceito de amizade diferente?"},
  {id:"21", type:"likert", text:"Intolerante com atitudes que julga inadequadas?"},
  {id:"22", type:"single", text:"Na infância, preferia amigos…", options:[
    {label:"Mais velhos", value:4},{label:"Tanto faz", value:2},
    {label:"Mesma idade", value:1},{label:"Mais novos", value:2}
  ]},

  {id:"hdr3", type:"section", text:"Habilidade acima da média (H)"},
  {id:"23", type:"likert", text:"Memória muito destacada nos temas de interesse."},
  {id:"24", type:"likert", text:"Muitas informações acumuladas nos temas de interesse."},
  {id:"25", type:"likert", text:"Vocabulário mais avançado/rico nos temas de interesse."},
  {id:"26", type:"likert", text:"Entende coisas complexas “por partes”."},
  {id:"27", type:"likert", text:"Aprende rápido o que interessa e transfere para outras áreas."},
  {id:"28", type:"likert", text:"Percebe rapidamente relações parte–todo."},
  {id:"29", type:"likert", text:"Extrai mais de um sentido de histórias/filmes etc."},
  {id:"30", type:"likert", text:"Faz perguntas inteligentes (como/por quê)."},
  {id:"31", type:"likert", text:"Notas eram melhores que as da turma."},
  {id:"32", type:"likert", text:"Aprende mais rápido que os demais (no que interessa)."},
  {id:"33", type:"likert", text:"Adapta-se a novidades ou as modifica."},
  {id:"34", type:"likert", text:"Pensamento abstrato muito desenvolvido."},

  {id:"hdr4", type:"section", text:"Criatividade (C)"},
  {id:"35", type:"likert", text:"Ideias vistas como diferentes/esquisitas pelos demais."},
  {id:"36", type:"likert", text:"Muito curioso(a)."},
  {id:"37", type:"likert", text:"Muitas ideias/soluções/respostas incomuns e inteligentes."},
  {id:"38", type:"likert", text:"Gosta de arriscar para conseguir o que quer."},
  {id:"39", type:"likert", text:"Gosta de enfrentar desafios."},
  {id:"40", type:"likert", text:"Muito imaginativo(a)/inventivo(a)."},
  {id:"41", type:"likert", text:"Sensível às coisas bonitas."},
  {id:"42", type:"likert", text:"Inconformista e não se importa em ser diferente."},
  {id:"43", type:"likert", text:"Compreende ideias diferentes das suas."},
  {id:"44", type:"likert", text:"Fica chateado ao repetir algo que já sabe."},
  {id:"45", type:"likert", text:"Descobre novos caminhos para resolver problemas."},
  {id:"46", type:"likert", text:"Critica construtivamente e questiona autoritarismo."},

  {id:"hdr5", type:"section", text:"Itens invertidos (atenção, organização, regras)"},
  {id:"47", type:"likert", text:"Presta atenção mesmo que o assunto não interesse.", invert:true},
  {id:"48", type:"likert", text:"Cadernos completos e organizados.", invert:true},
  {id:"49", type:"likert", text:"Gosta de cumprir regras.", invert:true},

  {id:"hdr6", type:"section", text:"Comprometimento com a tarefa (T)"},
  {id:"50", type:"likert", text:"Dedica muito mais tempo/energia ao que gosta."},
  {id:"51", type:"likert", text:"Muito exigente e autocrítico, nunca satisfeito."},
  {id:"52", type:"likert", text:"Insiste em buscar soluções."},
  {id:"53", type:"likert", text:"Tem sua própria organização."},
  {id:"54", type:"likert", text:"Muito seguro e às vezes teimoso nas convicções."},
  {id:"55", type:"likert", text:"Precisa de muito estímulo para terminar o que gosta.", invert:true},
  {id:"56", type:"likert", text:"Deixa outras coisas para mergulhar no que interessa."},
  {id:"57", type:"likert", text:"Reconhece obstáculos quando planeja."},
  {id:"58", type:"likert", text:"Sabe estabelecer prioridades com facilidade."},
  {id:"59", type:"likert", text:"Define etapas/detalhes/métodos para uma atividade."},
  {id:"60", type:"likert", text:"Persistente no que interessa (conclui tarefas)."},
  {id:"61", type:"likert", text:"Interessado e eficiente na organização de tarefas."},

  {id:"hdr7", type:"section", text:"Liderança / Socioemocional (L)"},
  {id:"62", type:"likert", text:"Distingue consequências e efeitos das ações."},
  {id:"63", type:"likert", text:"Autossuficiente."},
  {id:"64", type:"likert", text:"Escolhido/preferido para liderança."},
  {id:"65", type:"likert", text:"Cooperativo com os demais."},
  {id:"66", type:"likert", text:"Tende a organizar o grupo."},
  {id:"67", type:"likert", text:"Persuasivo e sabe convencer."},

  {id:"hdr8", type:"section", text:"Artes / Esportes (A) — destaques"},
  {id:"68", type:"tri", text:"Artes visuais — destaque?"},
  {id:"69", type:"tri", text:"Música/Canto — destaque?"},
  {id:"70", type:"tri", text:"Dança — destaque?"},
  {id:"71", type:"tri", text:"Informática/Tecnologia — destaque?"},
  {id:"72", type:"tri", text:"Esportes/Artes marciais/Ginástica — destaque?"},
  {id:"73", type:"tri", text:"Teatro — destaque?"},
  {id:"74", type:"tri", text:"Outra atividade — destaque?"},
  {id:"74txt", type:"text", text:"Se marcou 'Outra atividade', qual? (opcional)"},
  {id:"75", type:"tri", text:"Já obteve premiação/distinção nessas atividades?"},
  {id:"76", type:"hours", text:"Horas/semana dedicadas às atividades artísticas/esportivas."}
];

/* ===== DOMÍNIOS ===== */
// H: 6A, 6B, 8, 9, 13–15, 17–19, 23–34, 43, 62–63
const H_IDS = ["6A","6B","8","9","13","14","15","17","18","19",
               "23","24","25","26","27","28","29","30","31","32","33","34",
               "43","62","63"];
// C: 35–41, 44–46
const C_IDS = ["35","36","37","38","39","40","41","44","45","46"];
// T: 50–61 (55 invertida já no schema)
const T_IDS = ["50","51","52","53","54","55","56","57","58","59","60","61"];
// L: 1–3, 7, 10–12, 16, 20–22, 47–49 (invertidas), 64–67
const L_IDS = ["1","2","3","7","10","11","12","16","20","21","22","47","48","49","64","65","66","67"];
// A: 68–76 (com teto especial)
const A_IDS = ["68","69","70","71","72","73","74","75","76"];

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `AHSD_HET_${TOKEN||'anon'}`;

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  for(const it of ITEMS){
    if(it.type==="section"){
      const s=document.createElement('div'); s.className='section'; s.textContent=it.text; host.appendChild(s); continue;
    }
    const row = document.createElement('div'); row.className='item'; row.dataset.q = it.id;
    const stem = document.createElement('div'); stem.className='stem'; stem.id = `s_${it.id}`;
    const labelNumber = /^\d/.test(it.id) ? it.id : it.id.replace(/[^A-Za-z0-9]/g,"");
    stem.textContent = `${labelNumber}. ${it.text}`;
    row.appendChild(stem);

    if(it.type==="likert" || it.type==="tri" || it.type==="hours" || it.type==="single"){
      const choices = document.createElement('div'); choices.className='choices';
      const base = it.type==="likert" ? LIKERT : it.type==="tri" ? TRI : it.type==="hours" ? HOURS : it.options;
      base.forEach(opt=>{
        const lab = document.createElement('label'); lab.className='opt'; lab.title = (opt.label || opt.l);
        const id = `q_${it.id}_${opt.value ?? opt.v}`;
        const val = opt.value ?? opt.v;
        const req = (it.required===false) ? "" : "required";
        lab.innerHTML = `<input type="radio" name="q_${it.id}" id="${id}" value="${val}" ${req} aria-labelledby="s_${it.id}">
                         <span>${opt.label || opt.l}</span>${(it.type!=="single")?`<small></small>`:''}`;
        choices.appendChild(lab);
      });
      row.appendChild(choices);
    }

    if(it.type==="checkbox"){
      const wrap = document.createElement('div'); wrap.className='chips';
      it.checkboxes.forEach((name,ix)=>{
        const id = `q_${it.id}_${ix}`;
        const lab = document.createElement('label'); lab.className='chip'; lab.innerHTML =
          `<input type="checkbox" name="q_${it.id}" id="${id}" value="${name}"><span>${name}</span>`;
        wrap.appendChild(lab);
      });
      const hint = document.createElement('div'); hint.className='muted'; hint.style.marginTop='6px';
      hint.textContent = "Pontuação = min(qtd marcadas, 4).";
      row.appendChild(wrap); row.appendChild(hint);
    }

    if(it.type==="text"){
      const r = document.createElement('div'); r.className='row';
      r.innerHTML = `<input type="text" id="q_${it.id}" placeholder="Digite aqui (opcional)"/>`;
      row.appendChild(r);
    }

    host.appendChild(row);
  }
}

/* ===== STORAGE/PROGRESS ===== */
function saveDraft(){
  const data = {};
  for(const it of ITEMS){
    if(it.type==="section") continue;
    if(it.type==="checkbox"){
      data[it.id] = $$(`input[name="q_${it.id}"]:checked`).map(e=>e.value);
    }else if(it.type==="text"){
      data[it.id] = $(`#q_${it.id}`)?.value || "";
    }else{
      const sel = $(`input[name="q_${it.id}"]:checked`);
      if(sel) data[it.id] = Number(sel.value);
    }
  }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const data = JSON.parse(raw);
    for(const [id,val] of Object.entries(data||{})){
      const it = ITEMS.find(x=>x.id===id); if(!it) continue;
      if(it.type==="checkbox"){
        (val||[]).forEach(v=>{ const el = $$(`input[name="q_${id}"]`).find(e=>e.value===v); if(el) el.checked = true; });
      }else if(it.type==="text"){
        const el = $(`#q_${id}`); if(el) el.value = val;
      }else{
        const el = $(`input[name="q_${id}"][value="${val}"]`); if(el) el.checked = true;
      }
    }
  }catch(_){}
}
function clearDraft(){ try { localStorage.removeItem(STORAGE_KEY); } catch (_){ } }

function isRequired(it){ return !(it.required===false); }
function isScored(it){ return !(it.score===false); }

function countAnswered(){
  let c=0;
  for(const it of ITEMS){
    if(it.type==="section"||it.type==="text") continue;
    if(!isRequired(it)) continue;
    if(it.type==="checkbox"){
      if($$(`input[name="q_${it.id}"]:checked`).length>0) c++;
    }else{
      if($(`input[name="q_${it.id}"]:checked`)) c++;
    }
  }
  return c;
}
function requiredCount(){
  return ITEMS.filter(it=> it.type!=="section" && it.type!=="text" && isRequired(it)).length;
}
function updateProgress(){
  const totalReq = requiredCount();
  const answered = countAnswered();
  $("#progressText").textContent = `Progresso: ${answered}/${totalReq}`;
  $("#bar").style.width = `${(answered/totalReq)*100}%`;
}

/* ===== SCORING ===== */
function valueOf(id){
  const it = ITEMS.find(x=>x.id===id);
  if(!it) return 0;
  if(it.type==="checkbox"){
    const n = $$(`input[name="q_${id}"]:checked`).length;
    return Math.min(n, 4);
  }
  if(it.type==="text" || it.type==="section") return 0;
  const sel = $(`input[name="q_${id}"]:checked`);
  if(!sel) return 0;
  let val = Number(sel.value);
  if(it.type==="likert" && it.invert){ val = 4 - val; }
  return val;
}
function sumIds(arr){ return arr.reduce((s,id)=> s + valueOf(id), 0); }
function scoreA(){
  const baseIds = ["68","69","70","71","72","73","74"];
  const base = baseIds.reduce((s,id)=> s + valueOf(id), 0);
  const capBase = Math.min(base, 8);
  const prem = Math.min(valueOf("75"), 4);
  const hrs = Math.min(valueOf("76"), 4);
  return capBase + prem + hrs; // máx 16
}
const H_MAX = 4 * H_IDS.length;
const C_MAX = 4 * C_IDS.length;
const T_MAX = 4 * T_IDS.length;
const L_MAX = 4 * L_IDS.length;
const A_MAX = 16;

function totalAndMax(){
  // soma todos os itens pontuáveis (exceto bloco A tratado à parte)
  const scored = ITEMS.filter(it=> isScored(it) && !["68","69","70","71","72","73","74","75","76"].includes(it.id));
  let t = 0, m = 0;
  for(const it of scored){
    t += valueOf(it.id);
    // cada item pontuável tem teto 4 (checkbox já capado em 4)
    m += 4;
  }
  // bloco A
  t += scoreA();
  m += A_MAX;
  return {total:t, max:m};
}
function pct(part, max){ return max ? Math.round((part/max)*100) : 0; }
function classify(indexPct, hPct, cPct, tPct){
  let cls = (indexPct >= 75) ? "Perfil muito consistente com AH/SD: convergência robusta entre itens e 2 de 3 domínios centrais (Habilidade acima da média/Criatividade/Envolvimento com a tarefa) ≥65% — frequentemente os três. A pessoa aprende muito rápido, cria soluções originais e sustenta dedicação quando há desafio."
          : (indexPct >= 60) ? "Indícios fortes de AH/SD: padrão consistente em múltiplos itens, normalmente com Habilidades acima da média e/ou Criatividade altos e Envolvimento com a tarefa moderado-alto. O perfil já aparece na prática (aprendizagem rápida, conexões incomuns, autonomia)."
          : (indexPct >= 40) ? "Potencial presente: há sinais parciais; geralmente 1–2 domínios acima (ex.: Habilidade acima da média e/ou Criatividade) com Envolvimento com a tarefa mediano. É um perfil com matéria-prima (curiosidade, vocabulário, memória, conexões rápidas) que ainda não virou desempenho constante."
          : "Poucos indícios: as respostas não sustentam um perfil amplo de AH/SD neste momento. Pode haver talentos pontuais, mas o padrão não é consistente entre Habilidade acima da média/Criatividade/Envolvimento com a tarefa.";
  if((cls.startsWith("Perfil") || cls.startsWith("Indícios"))){
    const strongCount = [hPct, cPct, tPct].filter(p=>p>=65).length;
    if(strongCount < 2){
      cls = "Potencial presente (recomenda-se avaliação aprofundada)";
    }
  }
  return cls;
}

/* ===== BOOT (token + paciente) ===== */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200); return;
    }

    renderPatientInfo(); renderQuestions(); restoreDraft(); updateProgress();
    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
       ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== UI EVENTS ===== */
addEventListener('change', (e)=>{
  if(e.target && (e.target.matches('input[type="radio"]') || e.target.matches('input[type="checkbox"]'))){
    saveDraft(); updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox('#msg','Rascunho salvo neste dispositivo.','ok'); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox('#msg','Rascunho apagado.','warn'); updateProgress(); });

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending = true; hideBox("#msg");
  const btn = $("#btnSubmit"); const originalText = btn.textContent; btn.disabled = true; btn.textContent = "Enviando…";
  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Validação: exige marcação em todos os itens obrigatórios (checkbox: ≥1)
    for(const it of ITEMS){
      if(it.type==="section" || it.type==="text" || it.required===false) continue;
      if(it.type==="checkbox"){
        if($$(`input[name="q_${it.id}"]:checked`).length===0){
          const row = $(`.item[data-q="${it.id}"]`); if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
          throw new Error(`Marque ao menos uma opção no item ${it.id}.`);
        }
      }else{
        const sel = $(`input[name="q_${it.id}"]:checked`);
        if(!sel){
          const row = $(`.item[data-q="${it.id}"]`); if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
          throw new Error(`Responda o item ${it.id}.`);
        }
      }
    }

    // Domínios
    const H = sumIds(H_IDS);
    const C = sumIds(C_IDS);
    const T = sumIds(T_IDS);
    const L = sumIds(L_IDS);
    const A = scoreA();

    const {total, max} = totalAndMax();
    const idx = pct(total, max);
    const hPct = pct(H, H_MAX);
    const cPct = pct(C, C_MAX);
    const tPct = pct(T, T_MAX);
    const lPct = pct(L, L_MAX);
    const aPct = pct(A, A_MAX);
    const cls = classify(idx, hPct, cPct, tPct);

    const categoria_csv = [
      `Habilidade acima da média=${H}`,`Habilidade acima da média_pct=${hPct}`,
      `Criatividade=${C}`,`Criatividade_pct=${cPct}`,
      `Envolvimento com a tarefa=${T}`,`Envolvimento com a tarefa_pct=${tPct}`,
      `Liderança=${L}`,`Liderança_pct=${lPct}`,
      `Artes/esporte=${A}`,`Artes/esporte_pct=${aPct}`,
      `TOTAL=${total}`,`MAX=${max}`,
      `IndicePct=${idx}`,`Classificacao=${cls}`,
      `HCT_ge65=${[hPct,cPct,tPct].filter(p=>p>=65).length}`
    ].join(',');

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "heterorrelato",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: ""
    });

    // Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) doneUpdates[k] = "sim"; });
    if(Object.keys(doneUpdates).length===0) doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
   

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false; btn.disabled = false; btn.textContent = originalText;
  }
});
</script>
</body>
</html>

